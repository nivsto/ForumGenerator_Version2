@using ForumGenerator.WebClient.Communication;
@using ServiceReference1;

@{
    string username = "";
    string password = "";
    int forumId = Convert.ToInt32(Request.QueryString["forumId"]);
    int subForumId = Convert.ToInt32(Request.QueryString["subForumId"]);

    if (HttpContext.Current.Session["forum_" + forumId + "username"] != null && HttpContext.Current.Session["forum_" + forumId + "password"] != null)
    {
        username = HttpContext.Current.Session["forum_" + forumId + "username"].ToString();
        password = HttpContext.Current.Session["forum_" + forumId + "password"].ToString();
    }
    
    Communicator communicator = new Communicator();
    List<Discussion> discussions = communicator.getDiscussions(forumId,subForumId);
    string forumName = communicator.getForums().Find(delegate(Forum f) { return f.forumId == forumId; }).forumName;
    string subForumName = communicator.getSubForums(forumId).Find(delegate(SubForum sf) { return sf.subForumId == subForumId; }).subForumTitle;    
    int pageHeight = discussions.Count() * 60 + 140;

    string error = null;

    if (IsPost) {
        switch ( Request.Form["loginout"] ) {
            case "login":
                username = Request.Form["username"];
                password = Request.Form["password"];
                ///////////// login code!
                try {
                    User u = communicator.login(forumId, username, password);
                    HttpContext.Current.Session["forum_" + forumId + "username"] = username;
                    HttpContext.Current.Session["forum_" + forumId + "password"] = password;
                }
                catch (Exception e) {
                    error = e.Message;
                }
                break;
            case "logout":
                communicator.logout(forumId, username, password);
                HttpContext.Current.Session.Remove("forum_" + forumId + "username"); 
                HttpContext.Current.Session.Remove("forum_" + forumId + "password");
                break; 
        }
    }
}


<html>
    <head>
        <meta content="text/html; charset=utf-8" />
        <link href="style.css" rel="stylesheet" type="text/css" />
        <title>The Nimbus Forum Generator</title>
    </head>

    <body>

        <!-- Header Section-->
		<div class="Header">
            <span style="display: block; float: left; clear: right; min-width: 60%; text-align:center"><img src="img/Nimbus_logo.png" /></span>
            <div style="display: block; float: left; clear: right; min-width: 40%; height: 110px;">
                @if (HttpContext.Current.Session["forum_" + forumId + "username"] == null)
                {
                    <form method="POST">
                        <span> 
                            <input type="text" name="username" class="userInput" placeholder ="User Name" />
                            <input type="password" name="password" class="userInput" placeholder="Password" />
                            <input type="submit" value="login" name="loginout" />
                        </span>
                    </form>
                    if(error != null) {
                        <span id="error_msg" style="color: red;">Error: @error</span>
                    }
                }
                else {
                    <span id="loggedin_details" style="color: white;">logged in as @username</span>
                    <form method="POST" style="padding-top:10px; padding-left: 20px;">
                        <span><input type="submit" name="loginout" value="logout"/></span>
                    </form>
                }
            </div>
            
		</div>

        <!-- Content Section-->
        <div class="BodyBox" style="height: @(pageHeight)px;">
            <table style="vertical-align: central; height: 30px;">
                <tr style="vertical-align:central">
                    <td><a href="index"><img style="vertical-align:central" src="img/Home_button.png" /></a></td>
                    <td style ="vertical-align: central; font-size: 16px; font-family: Overlock">&nbsp <a href="index">Home</a> -> <a href="forum?forumid=@forumId">@forumName</a> -> <a href="subforum?forumid=@forumId&subForumId=@subForumId">@subForumName</a></td>
                </tr>
            </table>
            @if (HttpContext.Current.Session["forum_" + forumId + "username"] != null)
            {
                <a href="post?forumId=@forumId&subForumId=@subForumId"><div class="postButton" style="position: relative; top: 6px; left: 8px;">+ Post New Discussion</div></a>
            }
			<div class="ForumsList">
				<div class="ListHeader">
					<h2>
						<span class="ListHeaderTitle">Title / Thread Starter</span>
                        <span class="ListHeaderStatistics">Replies</span>
                        <span class="ListHeaderLast">Last Post</span>
					</h2>
				</div>

                <!-- ForumList Section-->
                <ol id="forumChilds">
                    @foreach (Discussion d in discussions)
                    {
                        int commentCounter = @communicator.countCommentsPerDiscussion(forumId, subForumId, d.discussionId);
                        string discussion_img = "img/single_discussion_sign.png";
                        if (commentCounter > 0)
                        {
                            discussion_img = "img/multi_discussion_sign.png";
                        }
                        <li>
                            <div class="forum">
						        <div class="forumInfo">
							        <img src=@discussion_img class="forumIcon" alt="discussion_sign" />
                                    <div class="forumTitleContainer">
								        <h2 class="forumTitle">
									        <a href="discussion?forumId=@forumId&subforumid=@subForumId&discussionId=@d.discussionId">@d.title</a>
								        </h2>
						            </div>
                                    <span style="padding-left:68px;">Started by @d.publisher.userName at @d.publishDate</span>
						        </div>
                                <ul class="forumStats">
                                    <li>Comments: @commentCounter</li>
						        </ul>
                                <ul class="forumAdmin">
                                @{
                                    List<Comment> comments = communicator.getComments(forumId, subForumId, d.discussionId);
                                    if(comments.Count() > 0) {
                                        <li>@comments.Last().publisher.userName</li>
                                        <li>@comments.Last().publishDate</li>
                                    }
                                    else {
                                        <li>@d.publisher.userName</li>
                                        <li>@d.publishDate</li>
                                    }
                                }
						        </ul>
					        </div>
					    </li>                        
                    }
				</ol>
			</div>
		</div>
	</body>

</html>
